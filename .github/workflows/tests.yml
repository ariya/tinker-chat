name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
        - uses: actions/checkout@v3

        - uses: actions/setup-node@v3
          with:
            node-version: 18
            cache: 'npm'

        - name: Get and build llama.cpp
          run: |
            git clone https://github.com/ggerganov/llama.cpp.git
            cd llama.cpp && make

        - name: Download Phi 2 model
          run: curl -OL https://huggingface.co/TheBloke/dolphin-2_6-phi-2-GGUF/resolve/main/dolphin-2_6-phi-2.Q4_0.gguf

        - name: Run llama.cpp with Phi 2
          run: ./llama.cpp/server --host 0.0.0.0 -m ./dolphin-2_6-phi-2.Q4_0.gguf &

        - name: Wait until the API server is ready
          run: while ! curl -s 'http://localhost:8080/health' | grep 'ok'; do sleep 1; done
          timeout-minutes: 3

        - run: npm ci

        - run: npm start "When did Indonesia declare its independence?" | grep 'August 17'
          timeout-minutes: 7
          env:
            OPENAI_API_BASE: "http://127.0.0.1:8080"
